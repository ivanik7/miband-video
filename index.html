<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <video src="ba.mp4"></video>
    <canvas width="32" height="32"></canvas>
    <button id="connect">Connect</button>
    <pre id="pv"></pre>
    <pre id="log"></pre>
  </body>

  <script>
    const log = (string) => {
      console.log(string);

      if (typeof string === "string") {
        logEl.innerHTML += string + "\n";
      } else {
        logEl.innerHTML += JSON.stringify(string) + "\n";
      }
    };

    const q = (query) => document.querySelector(query);

    const preview = q("#pv");
    const logEl = q("#log");
    const video = q("video");
    const canvas = q("canvas");
    const ctx = canvas.getContext("2d");

    const h = 8;
    const w = 24;

    ctx.translate(w, 0);
    ctx.rotate(90 * (Math.PI / 180));

    let frame;

    const updateFrame = () => {
      ctx.drawImage(video, 0, 0, h, w);
      ctx.fill();

      frame = ctx.getImageData(0, 0, w, h);

      window.fkek = frame;
    };

    const getPixel = (x, y) => {
      const r = frame.data[(frame.width * y + x) * 4];
      const g = frame.data[(frame.width * y + x) * 4 + 1];
      const b = frame.data[(frame.width * y + x) * 4 + 2];
      const a = frame.data[(frame.width * y + x) * 4 + 3];
      return r + b + g + a > 255;
    };

    const send = async (char) => {
      let str = `kek\0lol`;

      var buf = new ArrayBuffer(str.length + 10);
      var bufView = new Uint8Array(buf);

      let pos = 0;
      bufView[pos++] = -6;
      bufView[pos++] = 1;
      bufView[pos++] = 12; // номер иконки

      for (let i = 0; i < str.length; i++) {
        bufView[pos++] = str.charCodeAt(i);
      }

      bufView[pos++] = 0xe2;
      bufView[pos++] = 0xa3;
      bufView[pos++] = 0xbf;

      bufView[pos++] = 0xe2;
      bufView[pos++] = 0xa3;
      bufView[pos++] = 0xbf;

      bufView[pos++] = 0xe2;
      bufView[pos++] = 0xa3;
      bufView[pos++] = 0xbf;

      bufView[pos++] = 0xe2;
      bufView[pos++] = 0xa3;
      bufView[pos++] = 0xbf;

      await char.writeValue(bufView);
    };

    q("#connect").addEventListener("click", async () => {
      try {
        log("Connecting..");
        // const dev = await navigator.bluetooth.requestDevice({
        //   acceptAllDevices: true,
        //   optionalServices: [0x1811],
        // });
        // log(dev);

        // dev.addEventListener("gattserverdisconnected", (...args) => {
        //   log("disconnect");
        //   log(args);
        // });

        // const gatt = await dev.gatt.connect();
        // log("connected");

        // const service = await gatt.getPrimaryService(0x1811);
        // const characteristic = await service.getCharacteristic(0x2a46);

        // await send(characteristic);

        const title = "i";
        const size = h * w * 3 + h + 10 + title.length;
        var buf = new ArrayBuffer(size);
        var bufView = new Uint8Array(buf);

        await video.play();

        while (!video.ended) {
          updateFrame();

          let text = "";
          let pos = 0;

          bufView[pos++] = -6; // WTF
          bufView[pos++] = 1;
          bufView[pos++] = 12; // icon number

          for (let i = 0; i < title.length; i++) {
            bufView[pos++] = title.charCodeAt(i);
          }

          bufView[pos++] = 0;

          for (let y = 0; y <= h; y += 4) {
            for (let x = 0; x < w; x += 2) {
              c = 0x2800;

              if (getPixel(x, y)) c += 1 << 0;
              if (getPixel(x, y + 1)) c += 1 << 1;
              if (getPixel(x, y + 2)) c += 1 << 2;
              if (getPixel(x, y + 3)) c += 1 << 6;
              if (getPixel(x + 1, y)) c += 1 << 3;
              if (getPixel(x + 1, y + 1)) c += 1 << 4;
              if (getPixel(x + 1, y + 2)) c += 1 << 5;
              if (getPixel(x + 1, y + 3)) c += 1 << 7;

              text += String.fromCharCode(c);

              bufView[pos++] = 0xe0 | (c >> 12);
              bufView[pos++] = 0x80 | ((c >> 6) & 0x3f);
              bufView[pos++] = 0x80 | (c & 0x3f);
            }
            text += "\n";
            // bufView[pos++] = 0x10;
          }
          preview.textContent = text;

          await new Promise((res) => setTimeout(res, 100));
          // characteristic.writeValue(bufView);
        }
      } catch (error) {
        log(error.message);
      }
    });

    // const kek = 0x13;
    // 12*16
    // 24*128
  </script>
</html>
